# 🛡️ 리스크 관리 (Risk Management)

## 1. 수수료 구조

### 1.1 거래소별 수수료

| 거래소 | 지정가 (Maker) | 시장가 (Taker) |
|:---|:---|:---|
| **업비트** | 0.05% | 0.05% |
| **바이낸스** | 0.02% | 0.04% |

### 1.2 총 비용 계산

```
┌─────────────────────────────────────────────────────┐
│              왕복 거래 비용 (시장가 기준)              │
├─────────────────────────────────────────────────────┤
│                                                     │
│   진입 (Entry)                                       │
│   ├── 업비트 매수: 0.05%                             │
│   └── 바이낸스 숏: 0.04%                             │
│   소계: 0.09%                                        │
│                                                     │
│   청산 (Exit)                                        │
│   ├── 업비트 매도: 0.05%                             │
│   └── 바이낸스 숏 청산: 0.04%                        │
│   소계: 0.09%                                        │
│                                                     │
│   기타                                               │
│   ├── 슬리피지 추정: 0.10%                           │
│   └── 환율 오차: 0.05% (1분봉 기준)                  │
│   소계: 0.15%                                        │
│                                                     │
│   ═══════════════════════════════════════════════   │
│   총 비용: 0.09% + 0.09% + 0.15% = 0.33%            │
│   (보수적 추정: 0.38%)                               │
└─────────────────────────────────────────────────────┘
```

### 1.3 손익분기점

| 비용 시나리오 | 총 비용 | 최소 목표 수익률 |
|:---|:---|:---|
| 낙관적 | 0.28% | 0.30% |
| **현실적** | **0.38%** | **0.40%** |
| 보수적 | 0.48% | 0.50% |

## 2. 예상 수익률

### 2.1 진입 패턴별 수익

| 진입 패턴 | 목표 수익률 | 수수료 (0.38%) | 순수익 |
|:---|:---|:---|:---|
| Level 1만 (40%) | 0.50% | 0.38% | **0.12%** |
| Level 2만 (60%) | 0.75% | 0.38% | **0.37%** |
| Level 1+2 (100%) | 0.70% | 0.38% | **0.32%** |

### 2.2 월간 예상 수익

| 시나리오 | 월 거래 횟수 | 평균 순수익 | 월 수익률 |
|:---|:---|:---|:---|
| 보수적 | 5회 | 0.25% | 1.25% |
| **현실적** | **10회** | **0.32%** | **3.2%** |
| 낙관적 | 15회 | 0.35% | 5.25% |

### 2.3 연간 예상 수익

| 시나리오 | 월 수익률 | 연 수익률 | 복리 |
|:---|:---|:---|:---|
| 보수적 | 1.25% | 15% | 16.1% |
| **현실적** | **3.2%** | **38.4%** | **46.2%** |
| 낙관적 | 5.25% | 63% | 85.6% |

## 3. 리스크 요소

### 3.1 환율 리스크

| 환율 타임프레임 | 오차 범위 | 영향도 |
|:---|:---|:---|
| 1일봉 | 0.16% ~ 1.0% | ★★★★★ 치명적 |
| 1시간봉 | 0.05% ~ 0.3% | ★★★☆☆ 중간 |
| **1분봉** | **~0.05%** | **★☆☆☆☆ 낮음** |

**해결책**: 1분봉 환율 API 사용 필수

### 3.2 슬리피지 리스크

| 상황 | 슬리피지 | 대응 |
|:---|:---|:---|
| 정상 시장 | 0.05%~0.10% | 시장가 주문 |
| 변동성 급증 | 0.20%~0.50% | 거래 보류 |
| 유동성 부족 | 0.50%+ | 진입 금지 |

### 3.3 거래소 리스크

| 리스크 | 발생 확률 | 대응 |
|:---|:---|:---|
| API 장애 | 중간 | 재시도 로직, 타임아웃 |
| 점검 시간 | 낮음 | 사전 확인, 포지션 청산 |
| 레이트 리미트 | 높음 | 쿼터 관리, 백오프 |

## 4. 긴급 정지 조건

### 4.1 자동 정지 트리거

```python
def check_emergency_stop():
    """
    긴급 정지 조건 확인
    """
    # 1. 최대 손실 초과
    if current_drawdown > 0.05:  # 5%
        return True, "EMERGENCY: 최대 손실 초과"
    
    # 2. API 연속 에러
    if consecutive_api_errors > 5:
        return True, "EMERGENCY: API 에러 다수"
    
    # 3. 거래소 점검
    if is_exchange_maintenance():
        return True, "EMERGENCY: 거래소 점검"
    
    # 4. 네트워크 불안정
    if get_network_latency() > 1000:  # 1초
        return True, "EMERGENCY: 네트워크 불안정"
    
    # 5. 비정상 김프
    if abs(current_kimp) > 10:  # 10% 초과
        return True, "WARNING: 비정상 김프"
    
    return False, None
```

### 4.2 긴급 정지 시 액션

```
┌─────────────────────────────────────────────────────┐
│                   긴급 정지 프로세스                  │
├─────────────────────────────────────────────────────┤
│                                                     │
│   1. 신규 진입 중단                                  │
│      └── entry_enabled = False                      │
│                                                     │
│   2. 기존 포지션 처리                                │
│      ├── 옵션 A: 즉시 청산 (손실 감수)               │
│      └── 옵션 B: 모니터링 유지 (수동 개입)           │
│                                                     │
│   3. 알림 발송                                       │
│      ├── Discord 웹훅                               │
│      └── 텔레그램 (선택)                             │
│                                                     │
│   4. 로그 기록                                       │
│      └── 긴급 정지 사유, 시간, 포지션 상태           │
│                                                     │
└─────────────────────────────────────────────────────┘
```

## 5. 포지션 리스크 관리

### 5.1 최대 포지션 제한

| 제한 | 값 | 이유 |
|:---|:---|:---|
| 최대 동시 포지션 | 1 | 복잡성 감소, 리스크 집중 방지 |
| 최대 투입 비율 | 95% | 예비비 5% 확보 |
| 레버리지 | 1x | 델타 중립 유지 |

### 5.2 롤백 메커니즘

```python
async def rollback_orders(upbit_order, binance_order):
    """
    한쪽만 체결된 경우 롤백
    
    시나리오:
    1. 업비트만 체결 → 업비트 즉시 매도
    2. 바이낸스만 체결 → 바이낸스 포지션 종료
    3. 둘 다 실패 → 롤백 불필요
    """
    # 업비트만 체결된 경우
    if not isinstance(upbit_order, Exception):
        await execute_upbit_sell(
            upbit_order['filled'],
            None  # 시장가
        )
        log.warning("롤백: 업비트 포지션 청산")
    
    # 바이낸스만 체결된 경우
    if not isinstance(binance_order, Exception):
        await execute_binance_close(
            binance_order['filled'],
            None  # 시장가
        )
        log.warning("롤백: 바이낸스 포지션 종료")
```

## 6. 모니터링 체크리스트

### 6.1 실시간 모니터링 항목

| 항목 | 주기 | 임계값 | 알림 |
|:---|:---|:---|:---|
| 김프 | 1분 | ±10% | Warning |
| Z-Score | 1분 | ±3.0 | Info |
| 포지션 PnL | 1분 | -2% | Alert |
| API 응답시간 | 30초 | 500ms | Warning |
| 환율 변동 | 1분 | ±0.5% | Info |

### 6.2 일일 리포트 항목

- 총 거래 횟수
- 승률
- 총 수익/손실
- 최대 손실 (MDD)
- 평균 보유 시간
- API 에러 횟수

## 7. 거래소 확장 계획

### 7.1 현재 구성

| 거래소 | 역할 | 우선순위 |
|:---|:---|:---|
| 업비트 | 국내 현물 | 1순위 |
| 바이낸스 | 해외 선물 | 1순위 |

### 7.2 확장 계획

```python
EXCHANGE_CONFIG = {
    'upbit': {
        'type': 'spot',
        'fee': 0.0005,
        'api_limit': 10,  # 초당
        'status': 'active',
    },
    'binance': {
        'type': 'futures',
        'fee': 0.0004,
        'api_limit': 1200,  # 분당
        'status': 'active',
    },
    # 추후 추가
    'bithumb': {
        'type': 'spot',
        'fee': 0.0025,
        'api_limit': 95,
        'status': 'planned',
    },
    'coinone': {
        'type': 'spot',
        'fee': 0.002,
        'api_limit': 90,
        'status': 'planned',
    },
}
```

---

## 📚 참고 자료

- [CCXT 라이브러리 문서](https://github.com/ccxt/ccxt)
- [업비트 API 가이드](https://docs.upbit.com/)
- [바이낸스 API 문서](https://binance-docs.github.io/apidocs/)
- [한국은행 경제통계시스템](https://ecos.bok.or.kr/)

---

**작성일**: 2025-12-11  
**버전**: 2.0  
**상태**: 문서 완료
